<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">stores/GeoObjectsStore.js | ETS API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
<script data-ice="userScript" src="user/script/0-script.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-style.css">
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/DashboardStore.js~DashboardStore.html">DashboardStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/EmployeesStore.js~EmployeeStore.html">EmployeeStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/FuelRatesStore.js~FuelRatesStore.html">FuelRatesStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/GeoObjectsStore.js~GeoObjectsStore.html">GeoObjectsStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/MissionsStore.js~MissionsStore.html">MissionsStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/NotificationsStore.js~NotificationsStore.html">NotificationsStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/ObjectsStore.js~ObjectsStore.html">ObjectsStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/ReportsStore.js~ReportsStore.html">ReportsStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/RoutesStore.js~RoutesStore.html">RoutesStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/SettingsStore.js~SettingsStore.html">SettingsStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/WaybillsStore.js~WaybillsStore.html">WaybillsStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDefaultDutyMission">getDefaultDutyMission</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDefaultDutyMissionTemplate">getDefaultDutyMissionTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDefaultDutyMissionsCreationTemplate">getDefaultDutyMissionsCreationTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDefaultMission">getDefaultMission</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDefaultMissionTemplate">getDefaultMissionTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDefaultMissionsCreationTemplate">getDefaultMissionsCreationTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDefaultBill">getDefaultBill</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">stores/GeoObjectsStore.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { Store } from &apos;flummox&apos;;
import _ from &apos;lodash&apos;;

class GeoObjectsStore extends Store {

  constructor(flux) {
    super();

    const geoObjectsActions = flux.getActions(&apos;geoObjects&apos;);

    this.register(geoObjectsActions.getODHs, this.handleGetList.bind(this, &apos;odhs&apos;));
    this.register(geoObjectsActions.updateODH, this.handleGetList.bind(this, &apos;odhs&apos;));
    this.register(geoObjectsActions.getSSPs, this.handleGetList.bind(this, &apos;ssps&apos;));
    this.register(geoObjectsActions.getFuelingWaterStations, this.handleGetList.bind(this, &apos;fuelingWaterStations&apos;));
    this.register(geoObjectsActions.getCarpools, this.handleGetList.bind(this, &apos;carpools&apos;));
    this.register(geoObjectsActions.getDangerZones, this.handleGetList.bind(this, &apos;dangerZones&apos;));
    this.register(geoObjectsActions.updateDT, this.handleGetList.bind(this, &apos;dts&apos;));
    this.register(geoObjectsActions.getDTs, this.handleGetList.bind(this, &apos;dts&apos;));
    this.register(geoObjectsActions.getGeozones, this.handleGetGeozones);
    this.register(geoObjectsActions.setSelectedPolysType, this.handleSetSelectedPolysType);

    this.register(geoObjectsActions.getGeozoneByTypeWithGeometry, this.handleGetGeozonesByType);

    this.state = {
      odhsList: [],
      sspsList: [],
      dtsList: [],
      fuelingWaterStationsList: [],
      carpoolsList: [],
      dangerZonesList: [],
      mspsList: [],

      odhsIndex: {},
      dtsIndex: {},
      sspsIndex: {},
      fuelingWaterStationsIndex: {},
      carpoolsIndex: {},
      dangerZonesIndex: {},

      /* &#x413;&#x435;&#x43E;&#x43C;&#x435;&#x442;&#x440;&#x438;&#x438; */
      geozonePolys: {},
      odhPolys: {},
      dtPolys: {},
      sspPolys: {},
      mspPolys: {},
      fuelingWaterStationPolys: {},
      carpoolPolys: {},

      selectedPolysTypes: [],
      selectedFeature: null
    };

  }

  handleGetList(name, {result}) {
    const statePropertyName = `${name}List`;
    this.setState({
      [statePropertyName]: result
    });
  }

  handleSetSelectedPolysType(type) {
    if (type === null) {
      this.setState({selectedPolysTypes: []});
      this.handleSelectFeature(null);
      return;
    }
    const { selectedPolysTypes } = this.state;
    const typeIndex = selectedPolysTypes.indexOf(type);

    if (typeIndex &gt; -1) {
      selectedPolysTypes.splice(typeIndex, 1);
      if (this.state.selectedFeature) {
        if (this.state.selectedFeature.featureType === type) {
          this.handleSelectFeature(null);
        }
      }
    } else {
      selectedPolysTypes.push(type);
    }

    this.setState({selectedPolysTypes});
  }

  handleGetGeozones(data) {
    const geozones = data.result;
    let geozonePolys = {};
    let odhPolys = {};
    let dtPolys = {};
    geozones.map( g =&gt; {
      if (g.geozone_type === &apos;ROAD&apos;) {
        odhPolys[g.id] = {
          shape: JSON.parse(g.shape),
          name: g.name,
          state: 1,
        }
      }
      if (g.geozone_type === &apos;DT&apos;) {
        dtPolys[g.id] = {
          shape: JSON.parse(g.shape),
          name: g.name,
          state: 1,
        }
      }
      geozonePolys[g.id] = {
        shape: JSON.parse(g.shape),
        name: g.name,
        state: 1,
      }
    });
    this.setState({geozonePolys, dtPolys, odhPolys});
  }

  handleGetGeozonesByType(response) {
    const { type, data = {} } = response;
    const { result = [] } = data;
    const polys = {};
    result.map(geozone =&gt; {
      let data = geozone;
      let shape = JSON.parse(geozone.shape);
      data.featureType = type;
      delete data.shape;
      polys[geozone.id] = Object.assign({}, {
        shape,
        data
      });
    });
    const polysByType = `${type}Polys`;

    this.setState({
      [polysByType]: polys
    });
  }

  getSelectedPolys() {
    const { selectedPolysTypes } = this.state;
    let polys = {};
    selectedPolysTypes.map(type =&gt; {
      Object.assign(polys, this.state[`${type}Polys`]);
    });

    return polys;
  }

  handleSelectFeature(selectedFeature) {
    // TODO &#x440;&#x435;&#x444;&#x430;&#x43A;&#x442;&#x43E;&#x440;&#x438;&#x43D;&#x433;
    if (selectedFeature !== null) {
      if (this.state.selectedFeature !== null) {
        const typePrev = this.state.selectedFeature.featureType;
        const polysByTypePrev = `${typePrev}Polys`;
        const polysPrev = this.state[polysByTypePrev];
        delete polysPrev[this.state.selectedFeature.id].selected;

        const type = selectedFeature.featureType;
        const polysByType = `${type}Polys`;
        const polys = this.state[polysByType];
        polys[selectedFeature.id].selected = true;
        this.setState({
          selectedFeature,
          [polysByTypePrev]: polysPrev,
          [polysByType]: polys
        });
      } else {
        const type = selectedFeature.featureType;
        const polysByType = `${type}Polys`;
        const polys = this.state[polysByType];
        polys[selectedFeature.id].selected = true;
        this.setState({
          selectedFeature,
          [polysByType]: polys
        });
      }
    } else {
      if (this.state.selectedFeature !== null) {
        const type = this.state.selectedFeature.featureType;
        const polysByType = `${type}Polys`;
        const polys = this.state[polysByType];
        delete polys[this.state.selectedFeature.id].selected;
        this.setState({
          selectedFeature,
          [polysByType]: polys
        });
      } else {
        this.setState({selectedFeature});
      }
    }
  }

  getSelectedFeature() {
    return this.state.selectedFeature;
  }

}

export default GeoObjectsStore;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
