<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">stores/PointsStore.js | ETS API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/stores/PointsStore.js~PointsStore.html">PointsStore</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">stores/PointsStore.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { Store } from &apos;flummox&apos;;
import statuses from &apos;constants/statuses&apos;;
import config from &apos;../config.js&apos;;
import ReconnectingWebSocket from &apos;../vendor/ReconnectingWebsocket.js&apos;;
import _ from &apos;lodash&apos;;

/**
 * &#x41D;&#x430;&#x447;&#x430;&#x43B;&#x44C;&#x43D;&#x43E;&#x435; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x435; &#x445;&#x440;&#x430;&#x43D;&#x438;&#x43B;&#x438;&#x449;&#x430;
 * @memberof PointsStore
 * @type {object}
 * @property {object|null} selected - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x430;&#x44F; &#x442;&#x43E;&#x447;&#x43A;&#x430;
 * @property {object} points - &#x438;&#x43D;&#x434;&#x435;&#x43A;&#x441; (&#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442; &#x43F;&#x43E; &#x430;&#x439;&#x434;&#x438;&#x448;&#x43D;&#x438;&#x43A;&#x430;&#x43C;) &#x442;&#x43E;&#x447;&#x435;&#x43A;
 * @property {object} filter - &#x43D;&#x430;&#x441;&#x442;&#x440;&#x43E;&#x439;&#x43A;&#x438; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x442;&#x43E;&#x447;&#x435;&#x43A;
 * @property {array}  filter.status - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x434;&#x43B;&#x44F; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x44B;
 * @property {array}  filter.type - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x434;&#x43B;&#x44F; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x442;&#x438;&#x43F;&#x44B; &#x422;&#x421;
 * @property {array}  filter.owner - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x434;&#x43B;&#x44F; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x43E;&#x440;&#x433;&#x430;&#x43D;&#x438;&#x437;&#x430;&#x446;&#x438;&#x438;-&#x432;&#x43B;&#x430;&#x434;&#x435;&#x43B;&#x44C;&#x446;&#x44B; &#x422;&#x421;
 * @property {object} byStatus - &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x43E; &#x442;&#x43E;&#x447;&#x435;&#x43A; &#x441;&#x43E; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x430;&#x43C;&#x438;
 * @property {object} byConnectionStatus - &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x43E; &#x442;&#x43E;&#x447;&#x435;&#x43A; &#x43D;&#x435; &#x43D;&#x430; &#x441;&#x432;&#x44F;&#x437;&#x438;/&#x43D;&#x430; &#x441;&#x432;&#x44F;&#x437;&#x438;
 * @property {boolean} trackingMode - &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D; &#x43B;&#x438; &#x440;&#x435;&#x436;&#x438;&#x43C; &#x441;&#x43B;&#x435;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x437;&#x430; 1 &#x442;&#x43E;&#x447;&#x43A;&#x43E;&#x439; (= &#x43C;&#x430;&#x440;&#x43A;&#x435;&#x440;&#x43E;&#x43C;, &#x411;&#x41D;&#x421;&#x41E;, &#x422;&#x421;)
 * @property {boolean} showTrackingGradient - &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D;&#x43E; &#x43B;&#x438; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x435; &#x446;&#x432;&#x435;&#x442;&#x43E;&#x432; &#x442;&#x440;&#x435;&#x43A;&#x430; &#x441; &#x433;&#x440;&#x430;&#x434;&#x438;&#x435;&#x43D;&#x442;&#x43E;&#x43C;
 * @property {boolean} isRenderPaused - &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D;&#x430; &#x43B;&#x438; &#x43F;&#x440;&#x438;&#x43E;&#x441;&#x442;&#x430;&#x43D;&#x43E;&#x432;&#x43A;&#x430; &#x440;&#x435;&#x43D;&#x434;&#x435;&#x440;&#x438;&#x43D;&#x433;&#x430; &#x442;&#x43E;&#x447;&#x435;&#x43A;
 * @property {string|null} singleCarTrack - &#x433;&#x43E;&#x441;. &#x43D;&#x43E;&#x43C;&#x435;&#x440; &#x422;&#x421;, &#x435;&#x441;&#x43B;&#x438; &#x43E;&#x43D; &#x435;&#x441;&#x442;&#x44C; &#x442;&#x43E; &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x430;&#x435;&#x442;&#x441;&#x44F; &#x440;&#x435;&#x436;&#x438;&#x43C; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x442;&#x43E;&#x43B;&#x44C;&#x43A;&#x43E; 1 &#x442;&#x43E;&#x447;&#x43A;&#x438;
 * @property {array} singleCarTrackDates - &#x434;&#x430;&#x442;&#x44B; &#x434;&#x43B;&#x44F; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x442;&#x440;&#x435;&#x43A;&#x430; &#x43F;&#x43E; 1 &#x411;&#x41D;&#x421;&#x41E;
 */
const initialState = {
  selected: null,
  points: {},
  filter: {
    status: statuses.map(s =&gt; s.id),
    type: [],
    owner: [],
  },
  byStatus: {
    1: 0,
    2: 0,
    3: 0,
    4: 0
  },
  byConnectionStatus: {
    0: 0,
    1: 0
  },
  trackingMode: false,
  showTrackingGradient: false,
  isRenderPaused: false,
  singleCarTrack: null,
  singleCarTrackDates: [],
}

/**
 * &#x425;&#x440;&#x430;&#x43D;&#x438;&#x43B;&#x438;&#x449;&#x435; &#x434;&#x43B;&#x44F; &#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442;&#x43E;&#x432; &#x442;&#x43E;&#x447;&#x435;&#x43A;, &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x430;&#x435;&#x43C;&#x44B;&#x445; &#x43D;&#x430; &#x43A;&#x430;&#x440;&#x442;&#x435;
 * @extends {Store}
 */
export default class PointsStore extends Store {

  /**
   * &#x41D;&#x430;&#x447;&#x430;&#x43B;&#x44C;&#x43D;&#x43E;&#x435; &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x435; &#x445;&#x440;&#x430;&#x43D;&#x438;&#x43B;&#x438;&#x449;&#x430;
   * @type {Object}
   * @property {object|null} selected=null - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x430;&#x44F; &#x442;&#x43E;&#x447;&#x43A;&#x430;
   * @property {object} points={} - &#x438;&#x43D;&#x434;&#x435;&#x43A;&#x441; (&#x43E;&#x431;&#x44A;&#x435;&#x43A;&#x442; &#x43F;&#x43E; &#x430;&#x439;&#x434;&#x438;&#x448;&#x43D;&#x438;&#x43A;&#x430;&#x43C;) &#x442;&#x43E;&#x447;&#x435;&#x43A;
   * @property {object} filter - &#x43D;&#x430;&#x441;&#x442;&#x440;&#x43E;&#x439;&#x43A;&#x438; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x442;&#x43E;&#x447;&#x435;&#x43A;
   * @property {array}  filter.status - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x434;&#x43B;&#x44F; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x44B;
   * @property {array}  filter.type - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x434;&#x43B;&#x44F; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x442;&#x438;&#x43F;&#x44B; &#x422;&#x421;
   * @property {array}  filter.owner - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x434;&#x43B;&#x44F; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x43E;&#x440;&#x433;&#x430;&#x43D;&#x438;&#x437;&#x430;&#x446;&#x438;&#x438;-&#x432;&#x43B;&#x430;&#x434;&#x435;&#x43B;&#x44C;&#x446;&#x44B; &#x422;&#x421;
   * @property {object} byStatus - &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x43E; &#x442;&#x43E;&#x447;&#x435;&#x43A; &#x441;&#x43E; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x430;&#x43C;&#x438;
   * @property {object} byConnectionStatus - &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x43E; &#x442;&#x43E;&#x447;&#x435;&#x43A; &#x43D;&#x435; &#x43D;&#x430; &#x441;&#x432;&#x44F;&#x437;&#x438;/&#x43D;&#x430; &#x441;&#x432;&#x44F;&#x437;&#x438;
   * @property {boolean} trackingMode=false - &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D; &#x43B;&#x438; &#x440;&#x435;&#x436;&#x438;&#x43C; &#x441;&#x43B;&#x435;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x437;&#x430; 1 &#x442;&#x43E;&#x447;&#x43A;&#x43E;&#x439; (= &#x43C;&#x430;&#x440;&#x43A;&#x435;&#x440;&#x43E;&#x43C;, &#x411;&#x41D;&#x421;&#x41E;, &#x422;&#x421;)
   * @property {boolean} showTrackingGradient=false - &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D;&#x43E; &#x43B;&#x438; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x435; &#x446;&#x432;&#x435;&#x442;&#x43E;&#x432; &#x442;&#x440;&#x435;&#x43A;&#x430; &#x441; &#x433;&#x440;&#x430;&#x434;&#x438;&#x435;&#x43D;&#x442;&#x43E;&#x43C;
   * @property {boolean} isRenderPaused=false - &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D;&#x430; &#x43B;&#x438; &#x43F;&#x440;&#x438;&#x43E;&#x441;&#x442;&#x430;&#x43D;&#x43E;&#x432;&#x43A;&#x430; &#x440;&#x435;&#x43D;&#x434;&#x435;&#x440;&#x438;&#x43D;&#x433;&#x430; &#x442;&#x43E;&#x447;&#x435;&#x43A;
   * @property {string|null} singleCarTrack=null - &#x433;&#x43E;&#x441;. &#x43D;&#x43E;&#x43C;&#x435;&#x440; &#x422;&#x421;, &#x435;&#x441;&#x43B;&#x438; &#x43E;&#x43D; &#x435;&#x441;&#x442;&#x44C; &#x442;&#x43E; &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x430;&#x435;&#x442;&#x441;&#x44F; &#x440;&#x435;&#x436;&#x438;&#x43C; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x442;&#x43E;&#x43B;&#x44C;&#x43A;&#x43E; 1 &#x442;&#x43E;&#x447;&#x43A;&#x438;
   * @property {array} singleCarTrackDates - &#x434;&#x430;&#x442;&#x44B; &#x434;&#x43B;&#x44F; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x442;&#x440;&#x435;&#x43A;&#x430; &#x43F;&#x43E; 1 &#x411;&#x41D;&#x421;&#x41E;
   */
  static get initialState() {
    return {
      selected: null,
      points: {},
      filter: {
        status: statuses.map(s =&gt; s.id),
        type: [],
        owner: [],
      },
      byStatus: {
        1: 0,
        2: 0,
        3: 0,
        4: 0
      },
      byConnectionStatus: {
        0: 0,
        1: 0
      },
      trackingMode: false,
      showTrackingGradient: false,
      isRenderPaused: false,
      singleCarTrack: null,
      singleCarTrackDates: [],
    }
  }

  /**
   * &#x421;&#x43E;&#x437;&#x434;&#x430;&#x435;&#x442; &#x445;&#x440;&#x430;&#x43D;&#x438;&#x43B;&#x438;&#x449;&#x435;
   * @param {object} flux - &#x420;&#x435;&#x430;&#x43B;&#x438;&#x437;&#x430;&#x446;&#x438;&#x44F; flux
   */
  constructor(flux) {
    super();
    this.flux = flux;

    const pointsActions = flux.getActions(&apos;points&apos;);
    const loginActions = flux.getActions(&apos;session&apos;);
    this.register(pointsActions.updatePoints, this.handleUpdatePoints);
    this.register(pointsActions.setFilter, this.handleSetFilter);
    this.register(pointsActions.selectPoint, this.handleSelectPoint);
    this.register(pointsActions.setTracking, this.setTracking);
    this.register(pointsActions.createConnection, this._handleCreateConnection);
    this.register(pointsActions.closeConnection, this._handleCloseConnection);
    this.register(pointsActions.setSingleCarTrack, this.handleSetSingleCarTrack);
    this.register(pointsActions.setSingleCarTrackDates, this.handleSetSingleCarTrackDates);

    this.register(loginActions.login, this.handleLogin);

    this.state = _.cloneDeep(PointsStore.initialState);
  }

  /**
   * &#x423;&#x441;&#x442;&#x430;&#x43D;&#x430;&#x432;&#x43B;&#x438;&#x432;&#x430;&#x435;&#x442; &#x441;&#x43E;&#x435;&#x434;&#x438;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x43F;&#x43E; WebSocket &#x438; &#x443;&#x441;&#x442;&#x430;&#x43D;&#x430;&#x432;&#x43B;&#x438;&#x432;&#x430;&#x435;&#x442; &#x43F;&#x435;&#x440;&#x435;&#x434;&#x430;&#x447;&#x443; &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x445; &#x438;&#x437; ws &#x432; {@link PointsStore#handleUpdatePoints}
   * &#x442;&#x430;&#x43A; &#x436;&#x435; &#x443;&#x441;&#x442;&#x430;&#x43D;&#x430;&#x432;&#x43B;&#x438;&#x432;&#x430;&#x435;&#x442; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x43A;&#x443; &#x438;&#x432;&#x435;&#x43D;&#x442;&#x43E;&#x432; WebSocket
   * @method
   * @private
   */
  _handleCreateConnection() {
    const token = this.flux.getStore(&apos;session&apos;).getSession();
    let wsUrl = `${config.ws}?token=${token}`;
    this.ws = new ReconnectingWebSocket(wsUrl, null);

    this.ws.onmessage = ({data}) =&gt; {
      this.handleUpdatePoints(JSON.parse(data));
    }

    this.ws.onclose = () =&gt; {
      console.warn(&apos;WEBSOCKET - &#x41F;&#x43E;&#x442;&#x435;&#x440;&#x44F;&#x43D;&#x43E; &#x441;&#x43E;&#x435;&#x434;&#x438;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x441; WebSocket, &#x43F;&#x44B;&#x442;&#x430;&#x435;&#x43C;&#x441;&#x44F; &#x43F;&#x435;&#x440;&#x435;&#x43F;&#x43E;&#x434;&#x43A;&#x43B;&#x44E;&#x447;&#x438;&#x442;&#x44C;&#x441;&#x44F;&apos;);
    }
    this.ws.onerror = () =&gt; {
      console.error(&apos;WEBSOCKET - &#x41E;&#x448;&#x438;&#x431;&#x43A;&#x430; WebSocket&apos;);
    }

    this.unpauseRendering();
  }

  /**
   * &#x417;&#x430;&#x43A;&#x440;&#x44B;&#x432;&#x430;&#x435;&#x442; &#x441;&#x43E;&#x435;&#x434;&#x438;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x43F;&#x43E; WebSocket &#x438; &#x432;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x449;&#x430;&#x435;&#x442; state &#x432; initialState
   * @method
   * @private
   */
  _handleCloseConnection() {
    if (typeof this.ws !== &apos;undefined&apos;) {
      this.ws.close();
      this.ws = null;
    }
    this.setState(_.cloneDeep(PointsStore.initialState));
    this.pauseRendering();
  }

  handleSetSingleCarTrack(car_gov_number) {
    this.setState({singleCarTrack: car_gov_number});
  }

  handleSetSingleCarTrackDates(dates) {
    this.setState({singleCarTrackDates: dates});
  }

  /**
    * &#x41E;&#x431;&#x43D;&#x43E;&#x432;&#x43B;&#x44F;&#x435;&#x442; &#x442;&#x43E;&#x447;&#x43A;&#x438;
    * @method
    * @param {object} update - &#x43F;&#x43E;&#x441;&#x442;&#x443;&#x43F;&#x438;&#x432;&#x448;&#x438;&#x435; &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x43E; &#x442;&#x43E;&#x447;&#x43A;&#x430;&#x445;
    *
    * @todo &#x43E;&#x43F;&#x442;&#x438;&#x43C;&#x438;&#x437;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x441; https://github.com/mourner/rbush
    * https://github.com/mourner/rbush-knn
    */
  handleUpdatePoints(update) {
    let points = Object.assign({}, this.state.points);

    // TODO &#x43E;&#x442;&#x440;&#x435;&#x444;&#x430;&#x43A;&#x442;&#x43E;&#x440;&#x438;&#x442;&#x44C; &#x43C;&#x435;&#x445;&#x430;&#x43D;&#x438;&#x437;&#x43C; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x43A;&#x438; &#x43F;&#x43E;&#x43B;&#x443;&#x447;&#x435;&#x43D;&#x438;&#x44F; &#x442;&#x43E;&#x447;&#x435;&#x43A; &#x434;&#x43B;&#x44F; 1 &#x411;&#x41D;&#x421;&#x41E;
    if (this.state.singleCarTrack) {
      if (!this.state.selected) {
        _.map(points, p =&gt; {
          let car = p.car;
          if (car &amp;&amp; car.gov_number === this.state.singleCarTrack &amp;&amp; p.marker) { // &#x437;&#x430;&#x43C;&#x435;&#x43D;&#x438;&#x442;&#x44C; &#x43D;&#x430; car.gps_code
            p.marker.createTrack();
            p.marker.track.fetch(this.state.singleCarTrackDates[0] || undefined, this.state.singleCarTrackDates[1] || undefined);
            this.handleSelectPoint(p);
          }
        });
      }
    }

    for (let key in update) {
      let pointUpdate = update[key];

      // &#x435;&#x441;&#x43B;&#x438; &#x438;&#x43D;&#x444;&#x43E;&#x440;&#x43C;&#x430;&#x446;&#x438;&#x44F; &#x432; &#x43E;&#x431;&#x43D;&#x43E;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x438; &#x443;&#x441;&#x442;&#x430;&#x440;&#x435;&#x43B;&#x430; - &#x43D;&#x438;&#x447;&#x435;&#x433;&#x43E; &#x43D;&#x435; &#x434;&#x435;&#x43B;&#x430;&#x435;&#x43C;
      if (key in points &amp;&amp;
        points[key].timestamp &gt; pointUpdate.timestamp) {
        console.warn(&apos;got old info for point!&apos;);
        continue;
      }

      points[key] = Object.assign({}, points[key], pointUpdate);

      // TODO &#x440;&#x430;&#x437;&#x43E;&#x431;&#x440;&#x430;&#x442;&#x44C;&#x441;&#x44F; &#x447;&#x442;&#x43E; &#x44D;&#x442;&#x43E; &#x442;&#x430;&#x43A;&#x43E;&#x435;
      // HACK
      // whatever...
      /*if (points[key].speed !== 0 &amp;&amp; this.state.points[key] &amp;&amp; this.state.points[key].speed === 0) {
        points[key].coords = this.state.points[key].coords;
      }*/

    }

    let state = Object.assign({}, {
      points
    }, this.countDimensions(points));

    this.setState(state);
  }

  /**
   * &#x420;&#x430;&#x441;&#x447;&#x435;&#x442; &#x43A;&#x43E;&#x43B;&#x438;&#x447;&#x435;&#x441;&#x442;&#x432;&#x430; &#x430;&#x43A;&#x442;&#x438;&#x432;&#x43D;&#x44B;&#x445; &#x43C;&#x430;&#x448;&#x438;&#x43D; &#x43F;&#x43E; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x430;&#x43C;
   * @method
   * @param {object} points - &#x442;&#x43E;&#x447;&#x43A;&#x438;
   * @return {object} dimensions - &#x43A;&#x43E;&#x43B;-&#x432;&#x43E; &#x442;&#x43E;&#x447;&#x435;&#x43A; &#x432; &#x440;&#x430;&#x437;&#x440;&#x435;&#x437;&#x435; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x43E;&#x432; &#x438; &#x430;&#x43A;&#x442;&#x438;&#x432;&#x43D;&#x43E;&#x441;&#x442;&#x438;
   * @return {object} dimensions.byStatus - &#x43A;&#x43E;&#x43B;-&#x432;&#x43E; &#x442;&#x43E;&#x447;&#x435;&#x43A; &#x432; &#x440;&#x430;&#x437;&#x440;&#x435;&#x437;&#x435; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x43E;&#x432;
   * @return {object} dimensions.byConnectionStatus - &#x43A;&#x43E;&#x43B;-&#x432;&#x43E; &#x442;&#x43E;&#x447;&#x435;&#x43A; &#x432; &#x440;&#x430;&#x437;&#x440;&#x435;&#x437;&#x435; &#x430;&#x43A;&#x442;&#x438;&#x432;&#x43D;&#x43E;&#x441;&#x442;&#x438;
   */
  countDimensions(points = this.state.points) {

    if (this.isRenderPaused()) {
      return;
    }

    let byStatus = {
      1: 0,
      2: 0,
      3: 0,
      4: 0
    };

    let byConnectionStatus = {
      0: 0,
      1: 0
    }

    for (let key in points) {
      let point = points[key];
      if (this.isPointVisible(point)) {
        byStatus[point.status]++;
        byConnectionStatus[point.connection_status]++;
      }
    }

    return {
      byStatus,
      byConnectionStatus
    };
  }

  /**
   * &#x423;&#x441;&#x442;&#x430;&#x43D;&#x430;&#x432;&#x43B;&#x438;&#x432;&#x430;&#x435;&#x442; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;
   * @method
   * @public
   * @param {object} update - &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x43D;&#x44B;&#x439; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;
   */
  handleSetFilter(update) {
    let filter = Object.assign({}, this.state.filter, update);
    let selected = this.state.selected;

    this.setState(Object.assign({}, {filter, selected}, this.countDimensions()));
  }

  /**
   * &#x423;&#x441;&#x442;&#x430;&#x43D;&#x430;&#x432;&#x43B;&#x438;&#x432;&#x430;&#x435;&#x442; &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x443;&#x44E; &#x442;&#x43E;&#x447;&#x43A;&#x443;
   * @method
   * @param {object|false} selected
   */
  handleSelectPoint(selected) {

    if (!!selected === false) {
      this.setState({
        selected: false
      });
      return;
    }

    if (selected &amp;&amp; !selected.car) {
      return;
    }

    this.setState({
      selected,
      trackingMode: false
    });
  }

  /**
   * &#x41E;&#x431;&#x440;&#x430;&#x431;&#x430;&#x442;&#x44B;&#x432;&#x430;&#x435;&#x442; &#x43B;&#x43E;&#x433;&#x438;&#x43D; &#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x43E;&#x432;&#x430;&#x442;&#x435;&#x43B;&#x44F;, &#x443;&#x441;&#x442;&#x430;&#x43D;&#x430;&#x432;&#x43B;&#x438;&#x432;&#x430;&#x44F; &#x432; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440; &#x43F;&#x43E; &#x432;&#x43B;&#x430;&#x434;&#x435;&#x43B;&#x44C;&#x446;&#x430;&#x43C;
   * id &#x441;&#x442;&#x440;&#x43A;&#x443;&#x442;&#x443;&#x440;&#x43D;&#x43E;&#x433;&#x43E; &#x44D;&#x43B;&#x435;&#x43C;&#x435;&#x43D;&#x442;&#x430; &#x43E;&#x440;&#x433;&#x430;&#x43D;&#x438;&#x437;&#x430;&#x446;&#x438;&#x438; &#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x43E;&#x432;&#x430;&#x442;&#x435;&#x43B;&#x44F;
   * @method
   * @param {object} data - &#x43E;&#x442;&#x432;&#x435;&#x442; &#x441; &#x441;&#x435;&#x440;&#x432;&#x435;&#x440;&#x430;
   * @param {object} data.payload - &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x435; &#x43E; &#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x43E;&#x432;&#x430;&#x442;&#x435;&#x43B;&#x435;
   */
  handleLogin({payload}) {
    this.handleSetFilter({owner: [payload.company_id]});
  }

  /**
   * &#x412;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x449;&#x430;&#x435;&#x442; &#x43F;&#x440;&#x43E;&#x448;&#x435;&#x434;&#x448;&#x438;&#x435; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x44E; &#x442;&#x43E;&#x447;&#x43A;&#x438;
   * @method
   * @return {array} visiblePoints - &#x43F;&#x440;&#x43E;&#x448;&#x435;&#x434;&#x448;&#x438;&#x435; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x44E; &#x442;&#x43E;&#x447;&#x43A;&#x438;
   */
  getVisiblePoints() {
    let visiblePoints = [];

    for (let k in this.state.points) {
      let point = this.state.points[k];
      if (this.isPointVisible(point)) {
        visiblePoints.push(point)
      }
    }

    return visiblePoints;
  }

  /**
   * &#x41E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x44F;&#x435;&#x442;, &#x434;&#x43E;&#x441;&#x442;&#x443;&#x43F;&#x43D;&#x430; &#x43B;&#x438; &#x442;&#x43E;&#x447;&#x43A;&#x430; &#x434;&#x43B;&#x44F; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x432; &#x441;&#x43E;&#x43E;&#x442;&#x432;&#x435;&#x442;&#x441;&#x442;&#x432;&#x438;&#x438; &#x441; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x43E;&#x43C;
   * &#x438;&#x43D;&#x442;&#x435;&#x440;&#x444;&#x435;&#x439;&#x441; &#x434;&#x43B;&#x44F; PointsStore~_isPointVisible
   * @method
   * @public
   * @param {object} point - &#x442;&#x43E;&#x447;&#x43A;&#x430;
   * @return {function} PointsStore~_isPointVisible
   */
  isPointVisible(point) {
    return this._isPointVisible(point, this.state.filter);
  }

  /**
   * &#x423;&#x441;&#x442;&#x430;&#x43D;&#x430;&#x432;&#x43B;&#x438;&#x432;&#x430;&#x435;&#x442; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435; &#x440;&#x435;&#x436;&#x438;&#x43C;&#x430; &#x441;&#x43B;&#x435;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x437;&#x430; &#x442;&#x43E;&#x447;&#x43A;&#x43E;&#x439; (&#x411;&#x41D;&#x421;&#x41E;, &#x43C;&#x430;&#x440;&#x43A;&#x435;&#x440;&#x43E;&#x43C;, &#x422;&#x421;)
   * @method
   * @public
   * @param {boolean} value - &#x440;&#x435;&#x436;&#x438;&#x43C; &#x441;&#x43B;&#x435;&#x436;&#x435;&#x43D;&#x438;&#x44F;
   */
  setTracking(value) {
    this.setState({
      trackingMode: value
    });
  }

  /**
   * &#x423;&#x441;&#x442;&#x430;&#x43D;&#x430;&#x432;&#x43B;&#x438;&#x432;&#x430;&#x435;&#x442; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435; &#x438;&#x441;&#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x44F; &#x433;&#x440;&#x430;&#x434;&#x438;&#x435;&#x43D;&#x442;&#x430; &#x43F;&#x440;&#x438; &#x43E;&#x442;&#x440;&#x438;&#x441;&#x43E;&#x432;&#x43A;&#x435;
   * @todo &#x43F;&#x435;&#x440;&#x435;&#x43D;&#x435;&#x441;&#x442;&#x438; &#x432; &#x431;&#x43E;&#x43B;&#x435;&#x435; &#x43F;&#x43E;&#x434;&#x445;&#x43E;&#x434;&#x44F;&#x449;&#x435;&#x435; &#x43C;&#x435;&#x441;&#x442;&#x43E;
   * @method
   * @public
   * @param {boolean} flag - &#x438;&#x441;&#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x43E;&#x432;&#x430;&#x442;&#x44C; &#x433;&#x440;&#x430;&#x434;&#x438;&#x435;&#x43D;&#x442;
   */
  handleSetShowGradient(flag) {
    this.setState({
      showTrackingGradient: flag
    });
  }

  /**
   * &#x41E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x44F;&#x435;&#x442;, &#x434;&#x43E;&#x441;&#x442;&#x443;&#x43F;&#x43D;&#x430; &#x43B;&#x438; &#x442;&#x43E;&#x447;&#x43A;&#x430; &#x434;&#x43B;&#x44F; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x432; &#x441;&#x43E;&#x43E;&#x442;&#x432;&#x435;&#x442;&#x441;&#x442;&#x432;&#x438;&#x438; &#x441; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x43E;&#x43C;
   * @method
   * @private
   * @param {object} point - &#x442;&#x43E;&#x447;&#x43A;&#x430;
   * @param {object} filter - &#x437;&#x430;&#x434;&#x430;&#x43D;&#x43D;&#x430;&#x44F; &#x43A;&#x43E;&#x43D;&#x444;&#x438;&#x433;&#x443;&#x440;&#x430;&#x446;&#x438;&#x44F; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438;
   * @return {boolean} visible - &#x434;&#x43E;&#x441;&#x442;&#x443;&#x43F;&#x43D;&#x43E;&#x441;&#x442;&#x44C; &#x442;&#x43E;&#x447;&#x43A;&#x438; &#x434;&#x43B;&#x44F; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x435;&#x43D;&#x438;&#x44F;
   */
  _isPointVisible(point, filter) {
    let visible = true;

    // &#x415;&#x441;&#x43B;&#x438; &#x442;&#x43E;&#x447;&#x43A;&#x430; &#x43D;&#x435; &#x438;&#x43C;&#x435;&#x435;&#x442; &#x437;&#x430; &#x441;&#x43E;&#x431;&#x43E;&#x439; &#x422;&#x421;, &#x442;&#x43E; &#x43E;&#x43D;&#x430; &#x43D;&#x435; &#x434;&#x43E;&#x43B;&#x436;&#x43D;&#x430; &#x43E;&#x442;&#x43E;&#x431;&#x440;&#x430;&#x436;&#x430;&#x442;&#x44C;&#x441;&#x44F; &#x43D;&#x430; &#x43A;&#x430;&#x440;&#x442;&#x435;
    if (!point.car) {
      return false;
    }
    // &#x412; &#x441;&#x43B;&#x443;&#x447;&#x430;&#x435; &#x43D;&#x435;&#x437;&#x430;&#x434;&#x430;&#x43D;&#x43D;&#x43E;&#x439; &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438; &#x432;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x449;&#x430;&#x435;&#x43C; true
    if (!filter) {
      return visible;
    }
    // &#x412; &#x441;&#x43B;&#x443;&#x447;&#x430;&#x435; &#x435;&#x441;&#x43B;&#x438; &#x442;&#x43E;&#x447;&#x43A;&#x430; &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x430;, &#x43E;&#x43D;&#x430; &#x434;&#x43E;&#x43B;&#x436;&#x43D;&#x430; &#x431;&#x44B;&#x442;&#x44C; &#x432;&#x438;&#x434;&#x438;&#x43C;&#x430; &#x432;&#x43D;&#x435; &#x437;&#x430;&#x432;&#x438;&#x441;&#x438;&#x43C;&#x43E;&#x441;&#x442;&#x438; &#x43E;&#x442;
    // &#x444;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x438;
    if (this.state.selected !== null &amp;&amp; point.id === this.state.selected.id) {
      return true;
    }
    // &#x424;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x44F; &#x43F;&#x43E; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x443; &#x442;&#x43E;&#x447;&#x43A;&#x438;
    if (filter.status) {
      visible = visible &amp;&amp; filter.status.indexOf(point.status) !== -1;
      if (!visible) {
        return false;
      }
    }
    // &#x424;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x44F; &#x43F;&#x43E; &#x43D;&#x43E;&#x43C;&#x435;&#x440;&#x443; &#x411;&#x41D;&#x421;&#x41E; (GPS) &#x438;&#x43B;&#x438; &#x413;&#x43E;&#x441;. &#x43D;&#x43E;&#x43C;&#x435;&#x440;&#x443; &#x422;&#x421;
    if (filter.bnso_gos &amp;&amp; filter.bnso_gos.length &gt; 0) {
      let text = filter.bnso_gos.toLowerCase();
      visible = visible &amp;&amp; (
        point.car.gps_code.toLowerCase().indexOf(text) + 1 ||
        point.car.gov_number.toLowerCase().indexOf(text) + 1
      );
      if (!visible) {
        return false;
      }
    }
    // &#x424;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x44F; &#x43F;&#x43E; &#x442;&#x438;&#x43F;&#x443; &#x422;&#x421;
    if (filter.type &amp;&amp; filter.type.length &gt; 0) {
      visible = visible &amp;&amp; point.car &amp;&amp; filter.type.indexOf(point.car.type_id) !== -1;
      if (!visible) {
        return false;
      }
    }
    // &#x424;&#x438;&#x43B;&#x44C;&#x442;&#x440;&#x430;&#x446;&#x438;&#x44F; &#x43F;&#x43E; &#x43E;&#x440;&#x433;&#x430;&#x43D;&#x438;&#x437;&#x430;&#x446;&#x438;&#x438;-&#x432;&#x43B;&#x430;&#x434;&#x435;&#x43B;&#x44C;&#x446;&#x443; &#x422;&#x421;
    if (filter.owner &amp;&amp; filter.owner.length &gt; 0) {
      visible = visible &amp;&amp; point.car &amp;&amp; filter.owner.indexOf(Number(point.car.owner_id)) !== -1;
      if (!visible) {
        return false;
      }
    }
    return visible;
  }

  /**
   * &#x412;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x449;&#x430;&#x435;&#x442; &#x43C;&#x430;&#x440;&#x43A;&#x435;&#x440; &#x43F;&#x43E; &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x43E;&#x439; &#x442;&#x43E;&#x447;&#x43A;&#x435;
   * @method
   * @public
   * @return {Marker|null} marker - &#x43C;&#x430;&#x440;&#x43A;&#x435;&#x440;
   */
  getSelectedMarker() {
    if (this.state.selected) {
      return this.state.selected.marker;
    } else {
      return null;
    }
  }

  /**
   * &#x41E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x44F;&#x435;&#x442; &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x430; &#x43B;&#x438; &#x43A;&#x430;&#x43A;&#x430;&#x44F;-&#x43B;&#x438;&#x431;&#x43E; &#x442;&#x43E;&#x447;&#x43A;&#x430;
   * @method
   * @public
   * @return {boolean} isSelected - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x430; &#x43B;&#x438; &#x43A;&#x430;&#x43A;&#x430;&#x44F;-&#x43B;&#x438;&#x431;&#x43E; &#x442;&#x43E;&#x447;&#x43A;&#x430;
   */
  hasMarkerSelected() {
    return this.state.selected !== false &amp;&amp; this.state.selected !== null;
  }

  /**
   * &#x412;&#x43E;&#x437;&#x432;&#x440;&#x430;&#x449;&#x430;&#x435;&#x442; &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x443;&#x44E; &#x442;&#x43E;&#x447;&#x43A;&#x443;
   * @method
   * @public
   * @return {?Object} point - &#x432;&#x44B;&#x431;&#x440;&#x430;&#x43D;&#x43D;&#x430;&#x44F; &#x442;&#x43E;&#x447;&#x43A;&#x430;
   */
  getSelectedPoint() {
    return this.state.selected;
  }

  /**
   * &#x412;&#x44B;&#x43A;&#x43B;&#x44E;&#x447;&#x430;&#x435;&#x442; &#x43E;&#x431;&#x43D;&#x43E;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x435; &#x442;&#x43E;&#x447;&#x435;&#x43A;
   * @method
   * @public
   */
  pauseRendering() {
    this.setState({
      isRenderPaused: true
    });
  }

  /**
   * &#x412;&#x43A;&#x43B;&#x44E;&#x447;&#x430;&#x435;&#x442; &#x43E;&#x431;&#x43D;&#x43E;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x435; &#x442;&#x43E;&#x447;&#x435;&#x43A;
   * @method
   * @public
   */
  unpauseRendering() {
    this.setState({
      isRenderPaused: false
    });
  }

  /**
   * &#x41E;&#x43F;&#x440;&#x435;&#x434;&#x435;&#x43B;&#x44F;&#x435;&#x442; &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D;&#x43E; &#x43B;&#x438; &#x43E;&#x431;&#x43D;&#x43E;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x435; &#x442;&#x43E;&#x447;&#x435;&#x43A;
   * @method
   * @public
   * @return {boolean} isRenderPaused - &#x432;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D;&#x43E; &#x43B;&#x438; &#x43E;&#x431;&#x43D;&#x43E;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x435; &#x442;&#x43E;&#x447;&#x435;&#x43A;
   */
  isRenderPaused() {
    return this.state.isRenderPaused;
  }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
